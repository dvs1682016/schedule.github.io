<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>長輩貼心提醒</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .big-text { font-size: 1.25rem; }
        .huge-text { font-size: 1.5rem; }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes ring {
            0% { transform: rotate(0); }
            10% { transform: rotate(5deg); }
            20% { transform: rotate(-5deg); }
            30% { transform: rotate(5deg); }
            40% { transform: rotate(-5deg); }
            50% { transform: rotate(0); }
            100% { transform: rotate(0); }
        }
        .ringing {
            animation: ring 0.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- 頂部標題 -->
    <header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold tracking-tight">長輩貼心提醒</h1>
        <div class="flex items-center gap-2">
            <span id="audio-status" class="text-xs opacity-80">音訊點擊啟用</span>
            <div id="status-dot" class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
        </div>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-1 overflow-y-auto pb-24">
        <div id="view-list" class="space-y-6 p-4">
            <!-- 未來一週預告區 -->
            <div id="upcoming-section">
                <h2 class="text-lg font-bold text-orange-600 flex items-center mb-3">
                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"></path></svg>
                    心裡有個準備（未來一週）
                </h2>
                <div id="upcoming-container" class="flex overflow-x-auto gap-3 pb-2 no-scrollbar"></div>
            </div>

            <!-- 日期導航 -->
            <div class="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm border border-gray-200">
                <button onclick="changeViewDate(-1)" class="p-1 text-blue-600 shrink-0 active:scale-90 transition-transform">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex-1 min-w-0 text-center px-1">
                    <div id="display-date" class="text-xl sm:text-2xl font-black text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis">載入中...</div>
                    <button onclick="goToday()" class="text-blue-500 font-bold text-base border-b border-blue-500 mt-1">回到今天</button>
                </div>
                <button onclick="changeViewDate(1)" class="p-1 text-blue-600 shrink-0 active:scale-90 transition-transform">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <div class="space-y-3">
                <h2 class="text-lg font-bold text-gray-700 px-1">該日提醒清單</h2>
                <div id="reminder-container" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-add" class="hidden space-y-6 p-4">
            <h2 id="add-view-title" class="text-xl font-bold text-gray-700">設定新提醒</h2>
            <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4">
                <div>
                    <label class="block text-gray-500 mb-1 font-bold">提醒內容</label>
                    <input type="text" id="input-title" placeholder="例如：吃降血壓藥" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl focus:border-blue-500 outline-none bg-gray-50">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-500 mb-1 font-bold">日期</label>
                        <input type="date" id="input-date" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-gray-500 mb-1 font-bold">時間</label>
                        <input type="time" id="input-time" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-500 mb-1 font-bold">重複設定</label>
                    <select id="input-repeat" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50">
                        <option value="once">只提醒一次</option>
                        <option value="daily">每天提醒</option>
                    </select>
                </div>

                <!-- 測試音效按鈕 -->
                <div class="py-2">
                    <button onclick="testSound()" class="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 active:bg-gray-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        測試提示音效
                    </button>
                    <p class="text-xs text-center text-gray-400 mt-2">若沒聲音，請先隨意點擊畫面並確認音量</p>
                </div>

                <div class="flex gap-4 pt-2">
                    <button onclick="switchView('list')" class="flex-1 bg-gray-200 text-gray-600 py-4 rounded-2xl text-xl font-bold">取消</button>
                    <button id="btn-save" onclick="saveReminder()" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl text-2xl font-bold shadow-lg active:bg-blue-700">確認存檔</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部導覽欄 -->
    <nav class="shrink-0 bg-white border-t border-gray-200 flex h-20 items-stretch safe-area-bottom shadow-[0_-4px_12px_rgba(0,0,0,0.05)]">
        <button onclick="switchView('list')" id="nav-list" class="flex-1 flex flex-col items-center justify-center gap-1 text-blue-600 font-bold relative">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            <span class="text-sm">查看提醒</span>
            <div id="nav-indicator-list" class="absolute bottom-0 w-12 h-1 bg-blue-600 rounded-full"></div>
        </button>
        <button onclick="switchView('add')" id="nav-add" class="flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 font-bold relative">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <span class="text-sm">新增提醒</span>
            <div id="nav-indicator-add" class="absolute bottom-0 w-12 h-1 bg-blue-600 rounded-full hidden"></div>
        </button>
    </nav>

    <!-- 鬧鈴全螢幕彈窗 -->
    <div id="alarm-modal" class="fixed inset-0 bg-red-600 z-[100] flex flex-col items-center justify-center p-8 text-white text-center hidden">
        <div class="mb-10 ringing">
            <svg class="w-32 h-32" fill="white" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
        </div>
        <h2 class="text-3xl font-bold mb-4">時間到了！</h2>
        <div id="alarm-title" class="text-5xl font-black mb-16 break-words px-4 leading-tight">該吃藥囉</div>
        
<button id="btn-start-sound" onclick="userStartAlarmSound()" class="w-full max-w-sm bg-white/20 border-4 border-white text-white py-6 rounded-full text-3xl font-black shadow-2xl active:scale-95 transition-transform hidden mb-6">
    點一下啟用警報聲
</button>
        <button onclick="stopAlarm()" class="w-full max-w-sm bg-white text-red-600 py-8 rounded-full text-4xl font-black shadow-2xl active:scale-95 transition-transform">
            按這裡關閉
        </button>
    </div>

    <script>
        let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
        let currentViewDate = new Date().toISOString().split('T')[0];
        let editModeId = null;
        let audioContext = null;
        let audioUnlocked = false;
        let alarmInterval = null;

        // --- 強化手機音訊解鎖機制 ---
        
async function unlockAudio() {
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // iOS/Android: AudioContext 需要「使用者互動」才能真正解鎖
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }

        // 播放一個極短的靜音波（仍屬於一次有效的「播放」）
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime); // 幾乎靜音，避免部分手機完全 0 會被忽略
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.02);

        audioUnlocked = true;

        // 更新 UI 狀態
        document.getElementById('audio-status').innerText = "音訊已就緒";
        document.getElementById('status-dot').className = "w-3 h-3 bg-green-400 rounded-full";

        // 成功後移除監聽器（避免重複呼叫）
        document.removeEventListener('touchstart', unlockAudio);
        document.removeEventListener('click', unlockAudio);

        return true;
    } catch (e) {
        console.error("Audio Unlock Failed", e);
        audioUnlocked = false;
        document.getElementById('audio-status').innerText = "音訊尚未啟用";
        document.getElementById('status-dot').className = "w-3 h-3 bg-yellow-400 rounded-full animate-pulse";
        return false;
    }
}

        // 綁定到全域互動
        document.addEventListener('touchstart', () => { unlockAudio(); }, { passive: true });
        document.addEventListener('click', () => { unlockAudio(); });

        // 測試音效功能
        async function testSound() {
            await unlockAudio(); // 確保解鎖
            if (audioContext) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start();
                osc.stop(audioContext.currentTime + 0.5);
            }
        }

        window.onload = () => {
            updateDisplayDate();
            renderAll();
            setInterval(() => {
                checkAlarms();
                renderAll();
            }, 10000);
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
        };

        function renderAll() {
            renderReminders();
            renderUpcomingHighlights();
        }

        function renderUpcomingHighlights() {
            const container = document.getElementById('upcoming-container');
            const todayStr = new Date().toISOString().split('T')[0];
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];
            const upcoming = reminders.filter(r => r.enabled && r.date > todayStr && r.date <= nextWeekStr).sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

            if (upcoming.length === 0) {
                container.innerHTML = `<div class="flex-shrink-0 w-full p-6 border-2 border-dashed border-orange-200 rounded-2xl text-center text-orange-400 font-medium">目前沒有預告事項</div>`;
                return;
            }
            container.innerHTML = upcoming.map(r => {
                const diffDays = Math.ceil((new Date(r.date) - new Date(todayStr)) / (1000 * 60 * 60 * 24));
                return `<div onclick="jumpToDate('${r.date}')" class="flex-shrink-0 w-44 bg-orange-500 text-white p-4 rounded-2xl shadow-md active:scale-95 transition-transform"><div class="text-xs font-bold bg-orange-700 w-max px-2 py-0.5 rounded-full mb-2">${diffDays === 1 ? '就在明天！' : '還有 '+diffDays+' 天'}</div><div class="text-xl font-bold truncate">${r.title}</div><div class="text-sm opacity-90">${r.date.split('-')[1]}/${r.date.split('-')[2]} (${r.time})</div></div>`;
            }).join('');
        }

        function jumpToDate(date) {
            currentViewDate = date;
            updateDisplayDate();
            renderAll();
        }

        function updateDisplayDate() {
            const dateObj = new Date(currentViewDate);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            document.getElementById('display-date').innerText = `${currentViewDate} (${weekDays[dateObj.getDay()]})`;
        }

        function changeViewDate(days) {
            let d = new Date(currentViewDate);
            d.setDate(d.getDate() + days);
            currentViewDate = d.toISOString().split('T')[0];
            updateDisplayDate();
            renderAll();
        }

        function goToday() {
            currentViewDate = new Date().toISOString().split('T')[0];
            updateDisplayDate();
            renderAll();
        }

        function switchView(view) {
            const listV = document.getElementById('view-list');
            const addV = document.getElementById('view-add');
            const navL = document.getElementById('nav-list');
            const navA = document.getElementById('nav-add');
            const indL = document.getElementById('nav-indicator-list');
            const indA = document.getElementById('nav-indicator-add');

            if (view === 'list') {
                listV.classList.remove('hidden'); addV.classList.add('hidden');
                navL.classList.add('text-blue-600'); navL.classList.remove('text-gray-400');
                navA.classList.add('text-gray-400'); navA.classList.remove('text-blue-600');
                indL.classList.remove('hidden'); indA.classList.add('hidden');
                resetForm(); renderAll();
            } else {
                listV.classList.add('hidden'); addV.classList.remove('hidden');
                navA.classList.add('text-blue-600'); navA.classList.remove('text-gray-400');
                navL.classList.add('text-gray-400'); navL.classList.remove('text-blue-600');
                indA.classList.remove('hidden'); indL.classList.add('hidden');
            }
        }

        function saveReminder() {
            const title = document.getElementById('input-title').value.trim();
            const date = document.getElementById('input-date').value;
            const time = document.getElementById('input-time').value;
            const repeat = document.getElementById('input-repeat').value;
            if (!title || !date || !time) { document.getElementById('input-title').focus(); return; }
            if (editModeId) {
                const idx = reminders.findIndex(r => r.id === editModeId);
                if (idx !== -1) reminders[idx] = { ...reminders[idx], title, date, time, repeat, enabled: true };
            } else {
                reminders.push({ id: Date.now(), title, date, time, repeat, enabled: true, lastTriggered: null });
            }
            localStorage.setItem('reminders', JSON.stringify(reminders));
            switchView('list');
        }

        function editReminder(id) {
            const r = reminders.find(item => item.id === id);
            if (!r) return;
            editModeId = id;
            document.getElementById('add-view-title').innerText = "修改提醒內容";
            document.getElementById('input-title').value = r.title;
            document.getElementById('input-date').value = r.date;
            document.getElementById('input-time').value = r.time;
            document.getElementById('input-repeat').value = r.repeat;
            document.getElementById('btn-save').innerText = "確認修改";
            switchView('add');
        }

        function resetForm() {
            editModeId = null;
            document.getElementById('add-view-title').innerText = "設定新提醒";
            document.getElementById('input-title').value = '';
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('input-time').value = '';
            document.getElementById('input-repeat').value = 'once';
            document.getElementById('btn-save').innerText = "確認存檔";
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderAll();
        }

        function renderReminders() {
            const container = document.getElementById('reminder-container');
            const now = new Date();
            const nowDate = now.toISOString().split('T')[0];
            const nowTime = now.toTimeString().slice(0, 5);
            const filtered = reminders.filter(r => r.date === currentViewDate || r.repeat === 'daily');

            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center py-12 text-xl italic">這天沒有提醒項目</p>`;
                return;
            }

            container.innerHTML = filtered.sort((a,b) => a.time.localeCompare(b.time)).map(r => {
                const isPastDay = currentViewDate < nowDate;
                const isToday = currentViewDate === nowDate;
                let isExecuted = false;
                if (r.repeat === 'once') { if (!r.enabled || isPastDay || (isToday && r.time < nowTime)) isExecuted = true; }
                else if (r.repeat === 'daily') { if (isPastDay || (isToday && r.time < nowTime)) isExecuted = true; }

                return `<div class="${isExecuted ? 'bg-gray-200 opacity-70' : 'bg-white opacity-100'} p-4 rounded-2xl shadow-sm border-l-8 ${isExecuted ? 'border-gray-400' : 'border-blue-500'} flex justify-between items-center transition-all"><div class="flex-1 min-w-0"><div class="text-2xl font-bold truncate ${isExecuted ? 'text-gray-500' : 'text-gray-800'}">${r.title}</div><div class="text-lg text-gray-500">${r.time} ${r.repeat === 'daily' ? '<span class="text-blue-500 font-bold">(每天)</span>' : ''} ${isExecuted ? '<span class="text-sm">(已執行)</span>' : ''}</div></div><div class="flex gap-2 shrink-0 ml-2"><button onclick="editReminder(${r.id})" class="bg-blue-50 p-3 rounded-xl text-blue-600 active:scale-90"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button onclick="deleteReminder(${r.id})" class="bg-red-50 p-3 rounded-xl text-red-500 active:scale-90"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div>`;
            }).join('');
        }

        function checkAlarms() {
            const now = new Date();
            const nowDate = now.toISOString().split('T')[0];
            const nowTime = now.toTimeString().slice(0, 5);
            reminders.forEach(r => {
                if (!r.enabled) return;
                const isToday = r.date === nowDate || r.repeat === 'daily';
                const isTime = r.time === nowTime;
                const alreadyTriggered = r.lastTriggered === nowDate + ' ' + nowTime;
                if (isToday && isTime && !alreadyTriggered) triggerAlarm(r);
            });
        }

        function triggerAlarm(reminder) {
            document.getElementById('alarm-title').innerText = reminder.title;
            document.getElementById('alarm-modal').classList.remove('hidden');
            reminder.lastTriggered = new Date().toISOString().split('T')[0] + ' ' + reminder.time;
            if (reminder.repeat === 'once') reminder.enabled = false;
            localStorage.setItem('reminders', JSON.stringify(reminders));
            // 手機瀏覽器通常禁止「非使用者互動」自動出聲
            if (audioUnlocked && audioContext && audioContext.state !== 'suspended') {
                startBeeper(false);
            } else {
                document.getElementById('btn-start-sound').classList.remove('hidden');
                document.getElementById('audio-status').innerText = "請點一下啟用警報聲";
                document.getElementById('status-dot').className = "w-3 h-3 bg-yellow-400 rounded-full animate-pulse";
            }
            renderAll();
        }


async function userStartAlarmSound() {
    // 這個函式「一定」是由使用者點擊觸發（符合手機瀏覽器規則）
    const ok = await unlockAudio();
    if (ok) {
        document.getElementById('btn-start-sound').classList.add('hidden');
        startBeeper(true);
    }
}

        function startBeeper(fromUserGesture) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // 每次播放前嘗試恢復 Context
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                if (fromUserGesture) audioUnlocked = true;

                const playBeep = () => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    // 使用稍微多變的頻率，讓警示音更明顯
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, audioContext.currentTime);
                    osc.frequency.linearRampToValueAtTime(440, audioContext.currentTime + 0.5);
                    
                    gain.gain.setValueAtTime(0.5, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.5);
                };
                
                playBeep();
                if (alarmInterval) clearInterval(alarmInterval);
            document.getElementById('btn-start-sound').classList.add('hidden');
                alarmInterval = setInterval(playBeep, 1200);
            } catch (e) { console.error("Sound error:", e); }
        }

        function stopAlarm() {
            if (alarmInterval) clearInterval(alarmInterval);
            document.getElementById('btn-start-sound').classList.add('hidden');
            document.getElementById('alarm-modal').classList.add('hidden');
            renderAll();
        }
    </script>
</body>
</html>