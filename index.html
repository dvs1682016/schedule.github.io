import React, { useState, useEffect, useRef } from 'react';
import { ChevronLeft, ChevronRight, Edit2, Trash2, Calendar, Plus, Home, Bell, X } from 'lucide-react';

export default function App() {
  // --- 狀態管理 ---
  const [reminders, setReminders] = useState(() => {
    const saved = localStorage.getItem('reminders');
    return saved ? JSON.parse(saved) : [];
  });
  const [currentViewDate, setCurrentViewDate] = useState(new Date().toISOString().split('T')[0]);
  const [view, setView] = useState('list'); // 'list' 或 'add'
  const [editModeId, setEditModeId] = useState(null);
  const [formData, setFormData] = useState({ title: '', date: '', time: '', repeat: 'once' });
  const [activeAlarm, setActiveAlarm] = useState(null);
  
  const audioContextRef = useRef(null);
  const alarmIntervalRef = useRef(null);

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'elder-reminder-app';

  // --- 儲存資料到 LocalStorage ---
  useEffect(() => {
    localStorage.setItem('reminders', JSON.stringify(reminders));
  }, [reminders]);

  // --- 鬧鐘偵測邏輯 (每 10 秒檢查一次) ---
  useEffect(() => {
    const timer = setInterval(() => {
      const now = new Date();
      const nowDate = now.toISOString().split('T')[0];
      const nowTime = now.toTimeString().slice(0, 5);

      reminders.forEach(r => {
        if (!r.enabled) return;
        const isToday = r.date === nowDate || r.repeat === 'daily';
        const isTime = r.time === nowTime;
        const alreadyTriggered = r.lastTriggered === `${nowDate} ${nowTime}`;
        
        if (isToday && isTime && !alreadyTriggered) {
          triggerAlarm(r);
        }
      });
    }, 10000);
    return () => clearInterval(timer);
  }, [reminders]);

  // --- 鬧鐘觸發 ---
  const triggerAlarm = (reminder) => {
    setActiveAlarm(reminder);
    startBeeper();
    
    setReminders(prev => prev.map(r => {
      if (r.id === reminder.id) {
        return { 
          ...r, 
          lastTriggered: `${new Date().toISOString().split('T')[0]} ${r.time}`,
          enabled: r.repeat === 'once' ? false : r.enabled
        };
      }
      return r;
    }));
  };

  const startBeeper = () => {
    try {
      if (!audioContextRef.current) {
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContextRef.current.state === 'suspended') {
        audioContextRef.current.resume();
      }
      const playBeep = () => {
        const osc = audioContextRef.current.createOscillator();
        const gain = audioContextRef.current.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, audioContextRef.current.currentTime);
        gain.gain.setValueAtTime(0.5, audioContextRef.current.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContextRef.current.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(audioContextRef.current.destination);
        osc.start();
        osc.stop(audioContextRef.current.currentTime + 0.5);
      };
      playBeep();
      alarmIntervalRef.current = setInterval(playBeep, 1000);
    } catch (e) { console.error("Sound error:", e); }
  };

  const stopAlarm = () => {
    if (alarmIntervalRef.current) clearInterval(alarmIntervalRef.current);
    setActiveAlarm(null);
  };

  // --- 日期處理輔助 ---
  const getWeekDay = (dateStr) => {
    const date = new Date(dateStr);
    return ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][date.getDay()];
  };

  const changeDate = (days) => {
    const d = new Date(currentViewDate);
    d.setDate(d.getDate() + days);
    setCurrentViewDate(d.toISOString().split('T')[0]);
  };

  // --- 表單處理 ---
  const handleSave = () => {
    if (!formData.title || !formData.date || !formData.time) {
      return; // 實際應用中可加入 UI 提示
    }

    if (editModeId) {
      setReminders(prev => prev.map(r => r.id === editModeId ? { ...r, ...formData, enabled: true } : r));
    } else {
      const newReminder = {
        id: Date.now(),
        ...formData,
        enabled: true,
        lastTriggered: null
      };
      setReminders(prev => [...prev, newReminder]);
    }
    setEditModeId(null);
    setFormData({ title: '', date: '', time: '', repeat: 'once' });
    setView('list');
  };

  const startEdit = (reminder) => {
    setEditModeId(reminder.id);
    setFormData({ title: reminder.title, date: reminder.date, time: reminder.time, repeat: reminder.repeat });
    setView('add');
  };

  const deleteReminder = (id) => {
    setReminders(prev => prev.filter(r => r.id !== id));
  };

  // 過濾當日提醒
  const dayReminders = reminders.filter(r => r.date === currentViewDate || r.repeat === 'daily')
                               .sort((a, b) => a.time.localeCompare(b.time));

  // 未來一週預告
  const upcomingReminders = reminders.filter(r => {
    const today = new Date().toISOString().split('T')[0];
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    const nextWeekStr = nextWeek.toISOString().split('T')[0];
    return r.enabled && r.date > today && r.date <= nextWeekStr;
  }).sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

  return (
    <div className="flex flex-col h-screen bg-gray-100 text-gray-800 font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
      
      {/* 頂部標題 */}
      <header className="bg-blue-600 text-white p-4 flex justify-between items-center shadow-lg shrink-0">
        <h1 className="text-xl font-bold tracking-tight">長輩貼心提醒</h1>
        <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
      </header>

      {/* 主要內容區 */}
      <main className="flex-1 overflow-y-auto pb-24 p-4 space-y-6">
        
        {view === 'list' ? (
          <>
            {/* 未來一週預告 */}
            <section>
              <h2 className="text-orange-600 font-bold text-lg mb-3 flex items-center gap-2">
                <Calendar size={20} /> 心裡有個準備 (未來一週)
              </h2>
              <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                {upcomingReminders.length > 0 ? upcomingReminders.map(r => {
                  const diffDays = Math.ceil((new Date(r.date) - new Date(new Date().toISOString().split('T')[0])) / (1000 * 60 * 60 * 24));
                  return (
                    <button 
                      key={r.id} 
                      onClick={() => setCurrentViewDate(r.date)}
                      className="shrink-0 w-44 bg-orange-500 text-white p-4 rounded-2xl shadow-md active:scale-95 transition-transform text-left"
                    >
                      <div className="text-xs font-bold bg-orange-700 w-max px-2 py-0.5 rounded-full mb-1">
                        {diffDays === 1 ? '就在明天！' : `還有 ${diffDays} 天`}
                      </div>
                      <div className="text-xl font-bold truncate">{r.title}</div>
                      <div className="text-sm opacity-90">{r.date.slice(5)} ({r.time})</div>
                    </button>
                  );
                }) : (
                  <div className="w-full p-6 border-2 border-dashed border-orange-200 rounded-2xl text-center text-orange-400 font-medium">
                    目前沒有預告事項
                  </div>
                )}
              </div>
            </section>

            {/* 日期導覽 - 優化自適應與不換行 */}
            <section className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200">
              <div className="flex items-center justify-between gap-1 sm:gap-4">
                <button onClick={() => changeDate(-1)} className="p-2 text-blue-600 shrink-0">
                  <ChevronLeft size={40} />
                </button>
                
                <div className="flex-1 min-w-0 text-center">
                  {/* 使用 whitespace-nowrap 與縮放文字大小確保不換行 */}
                  <div className="text-xl sm:text-2xl font-black text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis px-1">
                    {currentViewDate} ({getWeekDay(currentViewDate).slice(2)})
                  </div>
                  <button 
                    onClick={() => setCurrentViewDate(new Date().toISOString().split('T')[0])}
                    className="mt-1 text-blue-500 font-bold text-base border-b border-blue-500"
                  >
                    回到今天
                  </button>
                </div>

                <button onClick={() => changeDate(1)} className="p-2 text-blue-600 shrink-0">
                  <ChevronRight size={40} />
                </button>
              </div>
            </section>

            {/* 提醒清單 */}
            <section className="space-y-3">
              <h2 className="text-lg font-bold text-gray-700 px-1">該日提醒清單</h2>
              {dayReminders.length > 0 ? dayReminders.map(r => {
                const isPast = r.date < new Date().toISOString().split('T')[0] || (r.date === new Date().toISOString().split('T')[0] && r.time < new Date().toTimeString().slice(0, 5));
                const isDone = !r.enabled || isPast;
                return (
                  <div key={r.id} className={`p-4 rounded-2xl border-l-8 flex justify-between items-center ${isDone ? 'bg-gray-200 border-gray-400 opacity-70' : 'bg-white border-blue-500 shadow-md'}`}>
                    <div className="flex-1 min-w-0">
                      <div className={`text-2xl font-bold truncate ${isDone ? 'text-gray-500' : 'text-gray-800'}`}>{r.title}</div>
                      <div className="text-lg text-gray-500">
                        {r.time} {r.repeat === 'daily' && <span className="text-blue-500">(每天)</span>}
                        {isDone && <span className="text-sm ml-1">(已執行)</span>}
                      </div>
                    </div>
                    <div className="flex gap-2 shrink-0">
                      <button onClick={() => startEdit(r)} className="bg-blue-50 p-3 rounded-xl text-blue-600"><Edit2 size={24}/></button>
                      <button onClick={() => deleteReminder(r.id)} className="bg-red-50 p-3 rounded-xl text-red-500"><Trash2 size={24}/></button>
                    </div>
                  </div>
                );
              }) : (
                <div className="py-12 text-center text-gray-400 text-xl italic">這天沒有提醒項目</div>
              )}
            </section>
          </>
        ) : (
          /* 新增/編輯視圖 */
          <div className="space-y-6">
            <h2 className="text-xl font-bold text-gray-700">{editModeId ? '修改提醒' : '設定新提醒'}</h2>
            <div className="bg-white p-6 rounded-3xl shadow-sm space-y-4">
              <div>
                <label className="block text-gray-500 mb-1 font-bold">提醒內容</label>
                <input 
                  type="text" 
                  value={formData.title}
                  onChange={e => setFormData({...formData, title: e.target.value})}
                  placeholder="例如：吃降血壓藥" 
                  className="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl focus:border-blue-500 outline-none bg-gray-50" 
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-gray-500 mb-1 font-bold">日期</label>
                  <input 
                    type="date" 
                    value={formData.date}
                    onChange={e => setFormData({...formData, date: e.target.value})}
                    className="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50" 
                  />
                </div>
                <div>
                  <label className="block text-gray-500 mb-1 font-bold">時間</label>
                  <input 
                    type="time" 
                    value={formData.time}
                    onChange={e => setFormData({...formData, time: e.target.value})}
                    className="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50" 
                  />
                </div>
              </div>
              <div>
                <label className="block text-gray-500 mb-1 font-bold">重複設定</label>
                <select 
                  value={formData.repeat}
                  onChange={e => setFormData({...formData, repeat: e.target.value})}
                  className="w-full p-4 border-2 border-gray-100 rounded-2xl text-xl outline-none bg-gray-50"
                >
                  <option value="once">只提醒一次</option>
                  <option value="daily">每天提醒</option>
                </select>
              </div>
              <div className="flex gap-4 pt-4">
                <button 
                  onClick={() => { setView('list'); setEditModeId(null); }}
                  className="flex-1 bg-gray-200 text-gray-600 py-4 rounded-2xl text-xl font-bold"
                >
                  取消
                </button>
                <button 
                  onClick={handleSave}
                  className="flex-[2] bg-blue-600 text-white py-4 rounded-2xl text-2xl font-bold shadow-lg"
                >
                  確認存檔
                </button>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* 底部導覽欄 */}
      <nav className="shrink-0 bg-white border-t border-gray-200 flex h-20 shadow-[0_-4px_12px_rgba(0,0,0,0.05)]">
        <button 
          onClick={() => setView('list')}
          className={`flex-1 flex flex-col items-center justify-center gap-1 ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}
        >
          <Home size={28} />
          <span className="text-sm font-bold">查看提醒</span>
          {view === 'list' && <div className="absolute bottom-0 w-12 h-1 bg-blue-600 rounded-full" />}
        </button>
        <button 
          onClick={() => {
            setFormData({ title: '', date: new Date().toISOString().split('T')[0], time: '', repeat: 'once' });
            setView('add');
          }}
          className={`flex-1 flex flex-col items-center justify-center gap-1 ${view === 'add' ? 'text-blue-600' : 'text-gray-400'}`}
        >
          <Plus size={28} />
          <span className="text-sm font-bold">新增提醒</span>
          {view === 'add' && <div className="absolute bottom-0 w-12 h-1 bg-blue-600 rounded-full" />}
        </button>
      </nav>

      {/* 鬧鈴全螢幕彈窗 */}
      {activeAlarm && (
        <div className="fixed inset-0 bg-red-600 z-[100] flex flex-col items-center justify-center p-8 text-white text-center">
          <div className="mb-10 animate-bounce">
            <Bell size={120} />
          </div>
          <h2 className="text-3xl font-bold mb-4">時間到了！</h2>
          <div className="text-5xl font-black mb-16 break-words px-4 leading-tight">
            {activeAlarm.title}
          </div>
          <button 
            onClick={stopAlarm}
            className="w-full max-w-sm bg-white text-red-600 py-8 rounded-full text-4xl font-black shadow-2xl active:scale-95 transition-transform"
          >
            按這裡關閉
          </button>
        </div>
      )}

      {/* CSS 修飾 */}
      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
}